function update(){window.kindle.messaging.sendMessage("com.lab126.chromebar","configureChrome",{appId:"xyz.penguins184.kindleforge",topNavBar:{template:"title",title:"App Store",buttons:[{id:"KPP_MORE",state:"enabled",handling:"system"},{id:"KPP_CLOSE",state:"enabled",handling:"system"}]},systemMenu:{clientParams:{profile:{name:"default",items:[{id:"KFORGE_RELOAD",state:"enabled",handling:"notifyApp",label:"Reload",position:0}],selectionMode:"none",closeOnUse:!0}}}})}window.kindle.appmgr.ongo=function(e){update(),window.kindle.messaging.receiveMessage("systemMenuItemSelected",function(e,n){"KFORGE_RELOAD"===n&&window.location.reload()})};var apps=null,lock=!1;function _fetch(e,n){var t=new XMLHttpRequest;t.open("GET",e,!0),t.onreadystatechange=function(){if(4===t.readyState&&200===t.status){if("function"==typeof n)n(t.responseText);else try{apps=JSON.parse(t.responseText),init()}catch(e){}}},t.send()}function _file(e){return new Promise(function(n){var t=document.createElement("iframe");t.src=e,document.body.appendChild(t),t.addEventListener("load",function(e){var t=e.target.contentDocument.documentElement.innerHTML;e.target.remove(),n(t.replace('<head></head><body><pre style="word-wrap: break-word; white-space: pre-wrap;">',"").replace("</pre></body>","").replace("<head></head><body></body>",""))}),setTimeout(function(){t.remove()},2e3)})}function init(){_file("file:///var/local/mesquite/KindleForge/assets/packages.list").then(function(e){render(e.split(/\r?\n/).filter(function(e){return""!==e.trim()}))})}function render(e){for(var n={download:"<svg class='icon' viewBox='0 0 24 24'><path d='M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4'></path><polyline points='7 10 12 15 17 10'></polyline><line x1='12' y1='15' x2='12' y2='3'></line></svg>",progress:"<svg class='icon' viewBox='0 0 24 24'><path d='M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8'></path><path d='M21 3v5h-5'></path><path d='M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16'></path><path d='M3 21v-5h5'></path></svg>",x:"<svg class='icon' viewBox='0 0 24 24'><line x1='18' y1='6' x2='6' y2='18'></line><line x1='6' y1='6' x2='18' y2='18'></line></svg>"},t=document.getElementById("apps");t.firstChild;)t.removeChild(t.firstChild);function a(e,t){var a=document.createElement("button");return a.className="install-button",a.setAttribute("data-name",e),a.setAttribute("data-installed",t?"true":"false"),a.innerHTML=(t?n.x:n.download)+(t?" Uninstall Application":" Install Application"),a}function i(e,n){_fetch("https://kindleforge.gingr.workers.dev/count?name="+encodeURIComponent(e),function(e){try{var t=JSON.parse(e);n(t.count||0)}catch(a){n(0)}})}for(var l=0;l<apps.length;l++){var r=apps[l],s=-1!==e.indexOf(r.name),o=document.createElement("article");o.className="card";var d=document.createElement("div");d.className="header";var c=document.createElement("div");c.className="title-box";var p=document.createElement("h2");p.className="title",p.textContent=r.name;var u=document.createElement("p");u.className="author",u.textContent="by "+r.author,c.appendChild(p),c.appendChild(u),d.appendChild(c);var h=document.createElement("p");h.className="description",h.textContent=r.description;var g=a(r.name,s);o.appendChild(d),o.appendChild(h),o.appendChild(g),t.appendChild(o)}for(var f=t.querySelectorAll(".install-button"),m=0;m<f.length;m++)!function(e){f[e].addEventListener("click",function(){var e=this,t=e.getAttribute("data-name"),a="true"===e.getAttribute("data-installed");if(e.disabled=!0,lock){e.innerHTML=n.x+(a?" Another Uninstall In Progress!":" Another Download In Progress!"),setTimeout(function(){e.disabled=!1,e.innerHTML=(a?n.x:n.download)+(a?" Uninstall Application":" Install Application")},3e3);return}lock=!0;var i="https://raw.githubusercontent.com/polish-penguin-dev/KindleForge/refs/heads/master/Registry/"+t+"/"+(a?"uninstall":"install")+".sh";e.innerHTML=n.progress+(a?" Uninstalling ":" Installing ")+t+"...",(window.kindle||top.kindle).messaging.sendStringMessage("com.kindlemodding.utild","runCMD","curl "+i+" | sh");var l=Date.now(),r=setInterval(function(){if(Date.now()-l>=3e4){clearInterval(r),lock=!1,e.disabled=!1,e.innerHTML=n.x+(a?" Failed to Uninstall ":" Failed to Install ")+t+"!",setTimeout(function(){window.location.reload()},5e3);return}_file("file:///var/local/mesquite/KindleForge/assets/packages.list").then(function(e){var n=-1!==e.indexOf(t);(!a&&n||a&&!n)&&(clearInterval(r),lock=!1,window.location.reload())})},500)})}(m)}document.addEventListener("DOMContentLoaded",function(){_fetch("https://raw.githubusercontent.com/polish-penguin-dev/KindleForge/refs/heads/master/Registry/registry.json"),document.getElementById("status").innerText="JS Working!"});