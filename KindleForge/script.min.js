var apps=null,lock=!1;function _fetch(e,t){var n=new XMLHttpRequest;n.open("GET",e,!0),n.onreadystatechange=function(){if(4===n.readyState&&200===n.status){if("function"==typeof t)t(n.responseText);else try{apps=JSON.parse(n.responseText),init()}catch(e){}}},n.send()}function _file(e){return new Promise(function(t){var n=document.createElement("iframe");n.src=e,document.body.appendChild(n),n.addEventListener("load",function(e){var n=e.target.contentDocument.documentElement.innerHTML;e.target.remove(),t(n.replace('<head></head><body><pre style="word-wrap: break-word; white-space: pre-wrap;">',"").replace("</pre></body>","").replace("<head></head><body></body>",""))}),setTimeout(function(){n.remove()},2e3)})}function init(){_file("file:///var/local/mesquite/KindleForge/assets/packages.list").then(function(e){render(e.split(/\r?\n/).filter(function(e){return""!==e.trim()}))})}function render(e){for(var t={download:"<svg class='icon' viewBox='0 0 24 24'><path d='M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4'></path><polyline points='7 10 12 15 17 10'></polyline><line x1='12' y1='15' x2='12' y2='3'></line></svg>",progress:"<svg class='icon' viewBox='0 0 24 24'><path d='M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8'></path><path d='M21 3v5h-5'></path><path d='M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16'></path><path d='M3 21v-5h5'></path></svg>",x:"<svg class='icon' viewBox='0 0 24 24'><line x1='18' y1='6' x2='6' y2='18'></line><line x1='6' y1='6' x2='18' y2='18'></line></svg>"},n=document.getElementById("apps");n.firstChild;)n.removeChild(n.firstChild);function a(e,n){var a=document.createElement("button");return a.className="install-button",a.setAttribute("data-name",e),a.setAttribute("data-installed",n?"true":"false"),a.innerHTML=(n?t.x:t.download)+(n?" Uninstall Application":" Install Application"),a}function i(e,t){_fetch("https://kindleforge.gingr.workers.dev/count?name="+encodeURIComponent(e),function(e){try{var n=JSON.parse(e);t(n.count||0)}catch(a){t(0)}})}for(var l=0;l<apps.length;l++){var r=apps[l],o=-1!==e.indexOf(r.name),s=document.createElement("article");s.className="card";var d=document.createElement("div");d.className="header";var c=document.createElement("div");c.className="title-box";var p=document.createElement("h2");p.className="title",p.textContent=r.name;var u=document.createElement("p");u.className="author",u.textContent="by "+r.author,c.appendChild(p),c.appendChild(u),d.appendChild(c);var h=document.createElement("p");h.className="description",h.textContent=r.description;var f=document.createElement("p");f.className="download-count",f.textContent="Downloads: ...",s.appendChild(f),i(r.name,function(e){f.textContent="Downloads: "+e});var v=a(r.name,o);s.appendChild(d),s.appendChild(h),s.appendChild(v),n.appendChild(s)}for(var $=n.querySelectorAll(".install-button"),g=0;g<$.length;g++)!function(e){$[e].addEventListener("click",function(){var e=this,n=e.getAttribute("data-name"),a="true"===e.getAttribute("data-installed");if(e.disabled=!0,lock){e.innerHTML=t.x+(a?" Another Uninstall In Progress!":" Another Download In Progress!"),setTimeout(function(){e.disabled=!1,e.innerHTML=(a?t.x:t.download)+(a?" Uninstall Application":" Install Application")},3e3);return}lock=!0;var i="https://raw.githubusercontent.com/polish-penguin-dev/KindleForge/refs/heads/master/Registry/"+n+"/"+(a?"uninstall":"install")+".sh";e.innerHTML=t.progress+(a?" Uninstalling ":" Installing ")+n+"...",(window.kindle||top.kindle).messaging.sendStringMessage("com.kindlemodding.utild","runCMD","curl "+i+" | sh");var l=Date.now(),r=setInterval(function(){if(Date.now()-l>=3e4){clearInterval(r),lock=!1,e.disabled=!1,e.innerHTML=t.x+(a?" Failed to Uninstall ":" Failed to Install ")+n+"!",setTimeout(function(){window.location.reload()},5e3);return}_file("file:///var/local/mesquite/KindleForge/assets/packages.list").then(function(e){var t=-1!==e.indexOf(n);(!a&&t||a&&!t)&&(clearInterval(r),lock=!1,window.location.reload())})},500)})}(g)}document.addEventListener("DOMContentLoaded",function(){_fetch("https://raw.githubusercontent.com/polish-penguin-dev/KindleForge/refs/heads/master/Registry/registry.json"),document.getElementById("status").innerText="JS Working!"});